<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{fragments/layout}">
<!--    #1. layout ë Œë”ë§    -->
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
   <div layout:fragment="content">
      <script type="text/javascript"
         src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=ded9jfxufa&callback=initMap"></script>

      <h2 class="mb-3">ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë§¤ì¥ ì¶”ì²œ</h2>

      <!-- ë²„íŠ¼ ì˜ì—­ -->
      <div class="mb-3">
         <button id="locateBtn" class="btn btn-primary me-2">ë‚´ ìœ„ì¹˜ ì°¾ê¸°</button>
         <button id="showAllBtn" class="btn btn-secondary">ëª¨ë“  ë§¤ì¥ í‘œì‹œ</button>
      </div>

      <!-- ì§€ë„ ì˜ì—­ -->
      <div id="map" class="border rounded"
         style="width: 100%; height: 500px;"></div>

      <!-- ê²°ê³¼ íŒ¨ë„ -->
      <div class="card mt-3">
         <div class="card-body">
            <h5 class="card-title">ì¶”ì²œ ê²°ê³¼</h5>
            <p id="resultText" class="card-text">ì•„ì§ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            <div id="storeList" class="list-group"></div>
         </div>
      </div>
      <!-- ì§€ë„ ë„£ê¸° -->
      <script id="code">
         let map;
         let userMarker;
         let storeMarkers = [];
         let stores = [];
      
         function initMap() {
      
            //1. ì§€ë„ ì´ˆê¸°í™” - ë§¤ì¥ì¢Œí‘œ
            stores = [
               { name: "ê°•ë‚¨ì ", lat: 37.498095, lng: 127.027610 },
               { name: "í™ëŒ€ì ", lat: 37.556343, lng: 126.922651 },
               { name: "ì¸ì²œì ", lat: 37.447275, lng: 126.690894 },
               { name: "ì‹œì²­ì ", lat: 37.566295, lng: 126.977945 }
            ];
      
            //2. ì§€ë„ ì´ˆê¸°í™” - ì¤‘ì‹¬ìœ„ì¹˜
            map = new naver.maps.Map('map', {
               center: new naver.maps.LatLng(37.3595704, 127.105399),
               zoom: 13
            });
      
            userMarker = new naver.maps.Marker({
               position: new naver.maps.LatLng(37.3595704, 127.105399),
               map: map,
               zIndex: 9999
            });
      
            document.getElementById("locateBtn").onclick = Recommend;
            document.getElementById("showAllBtn").onclick = ShowStores;
         }
      
         //3. ëª¨ë“  ë§¤ì¥ - ë§ˆì»¤ í‘œì‹œ
         function ShowStores() {
      
            storeMarkers.forEach(marker => marker.setMap(null));
            storeMarkers = [];
      
            stores.forEach(store => {
               const marker = new naver.maps.Marker({
                  position: new naver.maps.LatLng(store.lat, store.lng),
                  map: map
               });
               storeMarkers.push(marker);
            });
      
            document.getElementById("resultText").innerText =
               "ëª¨ë“  ë§¤ì¥ì„ ì§€ë„ì— í‘œì‹œí–ˆìŠµë‹ˆë‹¤.";
         }
         
         // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
         // ì§€ë„ë¥¼ êµ¬ë¡œ ë³´ê³  ë‘ ìœ„ë„ ê²½ë„ ì¢Œí‘œì‚¬ì´ì˜ ìµœë‹¨ê±°ë¦¬ë¥¼ ê³„ì‚°
         // ìœ„ë„ ê²½ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜í•œë’¤ ì‚¼ê°í•¨ìˆ˜ë¥¼ ì ìš©í•´ ê±°ë¦¬ë°˜í™˜
         function haversine(lat1, lng1, lat2, lng2) {
           const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
           const toRad = deg => deg * Math.PI / 180; //	ê°ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
           const dLat = toRad(lat2 - lat1);	// ìœ„ë„ì°¨ì´
           const dLng = toRad(lng2 - lng1); // ê²½ë„ì°¨ì´
           // Haversine í•µì‹¬ë¶€ë¶„
           const a = Math.sin(dLat/2)**2 +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLng/2)**2;
           //ìµœì¢…ê±°ë¦¬ê³„ì‚°
           return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
         }
      
         //4. í˜„ì¬ ìœ„ì¹˜ + ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¥ ì¶”ì²œ
     
          function Recommend() {
      
            if (!navigator.geolocation) {
               alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
               return;
            }
      
            navigator.geolocation.getCurrentPosition(pos => {
      
               const userLatLng = new naver.maps.LatLng(
                  pos.coords.latitude,
                  pos.coords.longitude
               );
      
               userMarker.setPosition(userLatLng);
               map.setCenter(userLatLng);
      
               let nearestStore = null;
               let minDistance = Infinity;
      
               stores.forEach(store => {
                  const storeLatLng =
                     new naver.maps.LatLng(store.lat, store.lng);
      
                  const distance =
                     naver.maps.GeometryUtil.getDistance(
                        userLatLng,
                        storeLatLng
                     );
      
                  if (distance < minDistance) {
                     minDistance = distance;
                     nearestStore = store;
                  }
               });
      
               document.getElementById("resultText").innerText =
                  `ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¥: ${nearestStore.name}
                   (ê±°ë¦¬: ${(minDistance / 1000).toFixed(2)}km)`;
            });
         } 
      </script>

   </div>
   <!--    http://localhost:8484/boot001/board/list -->
</body>
</html>