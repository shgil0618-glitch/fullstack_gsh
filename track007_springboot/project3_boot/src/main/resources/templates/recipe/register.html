<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
  <meta charset="UTF-8">
  <title>레시피 등록</title>
</head>
<body>
<div layout:fragment="content" class="container mt-5">
  <h3>새 레시피 작성</h3>

  <form id="recipeForm" th:action="@{/recipes/register}" method="post" enctype="multipart/form-data">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    

    <!-- 레시피 제목 -->
    <div class="mb-3 mt-3">
      <label for="title" class="form-label">레시피 제목 *</label>
      <input type="text" class="form-control" id="title" name="title" placeholder="예: 김치찌개" required>
    </div>

    <!-- 카테고리, 난이도 -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="category" class="form-label">카테고리 *</label>
        <select id="category" name="category" class="form-select" required>
          <option value="">-- 선택 --</option>
          <option value="2">한식</option>
          <option value="3">양식</option>
          <option value="4">중식</option>
          <option value="5">일식</option>
          <option value="6">디저트</option>
          <option value="7">건강식</option>
          <option value="8">기타</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label for="difficulty" class="form-label">난이도 *</label>
        <select id="difficulty" name="difficulty" class="form-select" required>
          <option value="">-- 선택 --</option>
          <option value="쉬움">쉬움</option>
          <option value="보통" selected>보통</option>
          <option value="어려움">어려움</option>
        </select>
      </div>
    </div>

    <!-- 조리 시간, 인분 -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="cookTime" class="form-label">조리 시간 (분) *</label>
        <input type="number" class="form-control" id="cookTime" name="cookTime" value="30" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="servings" class="form-label">인분 *</label>
        <input type="number" class="form-control" id="servings" name="servings" value="2" required>
      </div>
    </div>

    <!-- 대표 이미지 -->
    <div class="mb-3">
      <label for="mainImage" class="form-label">대표 이미지</label>
      <input type="file" class="form-control" id="mainImage" name="imageFile" required>
    </div>

    <!-- 레시피 설명 -->
    <div class="mb-3">
      <label for="description" class="form-label">레시피 설명 *</label>
      <textarea class="form-control" id="description" name="description" rows="3" placeholder="이 레시피에 대한 간단한 설명을 입력하세요" required></textarea>
    </div>

    <!-- 재료 추가 -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <label class="form-label">재료 *</label>
        <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredientBtn">+ 재료 추가</button>
      </div>
      <div id="ingredientsContainer" class="mt-2">
        <div class="row g-2 ingredient-row mb-2">
          <div class="col-5">
            <input type="text" class="form-control" name="ingredients[0].ingreName" placeholder="재료 1 이름" required>
          </div>
          <div class="col-5">
            <input type="text" class="form-control" name="ingredients[0].ingreNum" placeholder="재료 1 양" required>
          </div>
          <div class="col-2 d-grid">
            <button type="button" class="btn btn-danger btn-remove-ingre">삭제</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 조리 단계 추가 -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <label class="form-label">조리 방법 *</label>
        <button type="button" class="btn btn-sm btn-outline-primary" id="addStepBtn">+ 단계 추가</button>
      </div>
      <div id="instructionsContainer" class="mt-2">
        <div class="card p-3 mb-2 instruction-group">
          <label><span class="step-number">1</span>. 조리 단계 설명</label>
          <textarea class="form-control instruction-text" name="steps[0].stepDesc" rows="2" placeholder="조리 단계 1 설명" required></textarea>
          <div class="mt-2">
            <label class="form-label">단계별 이미지 (선택)</label>
            <input type="file" name="stepImages" class="form-control">
          </div>
          <button type="button" class="btn btn-sm btn-danger mt-2 btn-remove-step" style="width: 80px;">단계 삭제</button>
        </div>
      </div>
    </div>
    
    <!-- 레시피 URL 입력 -->
<div class="mb-3">
  <label for="rUrl" class="form-label">레시피 URL</label>
  <input type="text" class="form-control" id="rUrl" name="rUrl" placeholder="예: https://example.com/my-recipe">
</div>

    <!-- 숨겨진 입력 필드 -->
    <!-- 필요시 매퍼에서 요구하는 추가 hidden 값들 -->
    <input type="hidden" name="appUserId" th:value="${#authentication.principal.user.appUserId}">
    <input type="hidden" name="provider" th:value="${#authentication.principal.user.provider}">
     <!-- 공개 상태: 기본값 PUBLIC을 hidden으로 전달 -->
	<input type="hidden" name="status" value="PUBLIC">

    <!-- 제출 버튼 -->
    <div class="d-flex justify-content-end mt-4">
      <button type="button" class="btn btn-secondary me-2" onclick="history.back()">취소</button>
      <button type="submit" class="btn btn-warning">레시피 등록</button>
    </div>
  </form>

 <script>
document.addEventListener('DOMContentLoaded', function() {
  const ingredientsContainer = document.getElementById('ingredientsContainer');
  const addIngredientBtn = document.getElementById('addIngredientBtn');
  const instructionsContainer = document.getElementById('instructionsContainer');
  const addStepBtn = document.getElementById('addStepBtn');

  /* ------------------
     재료 index 정리
  ------------------ */
  function reindexIngredients() {
    const rows = ingredientsContainer.querySelectorAll('.ingredient-row');
    rows.forEach((row, idx) => {
      row.querySelector("input[name*='ingreName']")
         .name = `ingredients[${idx}].ingreName`;
      row.querySelector("input[name*='ingreNum']")
         .name = `ingredients[${idx}].ingreNum`;
    });
  }

  /* ------------------
     단계 index 정리
  ------------------ */
  function renumberSteps() {
    const steps = instructionsContainer.querySelectorAll('.instruction-group');
    steps.forEach((step, idx) => {
      step.querySelector('.step-number').textContent = idx + 1;
      step.querySelector('.instruction-text')
          .name = `steps[${idx}].stepDesc`;
      step.querySelector("input[type='file']")
          .name = "stepImages";
    });
  }

  /* ------------------
     재료 추가
  ------------------ */
  addIngredientBtn.addEventListener('click', () => {
    const idx = ingredientsContainer.querySelectorAll('.ingredient-row').length;
    const newRow = document.createElement('div');
    newRow.className = 'row g-2 ingredient-row mb-2';
    newRow.innerHTML = `
      <div class="col-5">
        <input type="text" class="form-control"
               name="ingredients[${idx}].ingreName" required>
      </div>
      <div class="col-5">
        <input type="text" class="form-control"
               name="ingredients[${idx}].ingreNum" required>
      </div>
      <div class="col-2 d-grid">
        <button type="button"
                class="btn btn-danger btn-remove-ingre">삭제</button>
      </div>
    `;
    ingredientsContainer.appendChild(newRow);
  });

  ingredientsContainer.addEventListener('click', e => {
    if (e.target.classList.contains('btn-remove-ingre')) {
      e.target.closest('.ingredient-row').remove();
      reindexIngredients();
    }
  });

  /* ------------------
     단계 추가
  ------------------ */
  addStepBtn.addEventListener('click', () => {
    const idx = instructionsContainer.querySelectorAll('.instruction-group').length;
    const newStep = document.createElement('div');
    newStep.className = 'card p-3 mb-2 instruction-group';
    newStep.innerHTML = `
      <label><span class="step-number">${idx + 1}</span>. 조리 단계 설명</label>
      <textarea class="form-control instruction-text"
                name="steps[${idx}].stepDesc"
                rows="2" required></textarea>
      <div class="mt-2">
        <input type="file" name="stepImages" class="form-control">
      </div>
      <button type="button"
              class="btn btn-sm btn-danger mt-2 btn-remove-step">
        단계 삭제
      </button>
    `;
    instructionsContainer.appendChild(newStep);
  });

  instructionsContainer.addEventListener('click', e => {
    if (e.target.classList.contains('btn-remove-step')) {
      e.target.closest('.instruction-group').remove();
      renumberSteps();
    }
  });
});
</script>

</div>
</body>
</html>