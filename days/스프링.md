#1. 프레임워크
    - 소프트웨어 개발의 뼈대역할
    - 실행흐름 담당
#2. ioc 
    - 인스턴스 생성 ~ 소멸까지 생명주기를 스프링이 관리
#3. DI 
    - 각 클래스의 의존관계를 [설정파일]을 통해서 컨테이너가 자동연결
#4. BEAN
    - 관리되는 객체

#5. 예시) 
class MyA {
    PRIVATE STRING name;
    PRIVATE ANIMAL ani;


}
---------------------------------------------
1. setter 방식
<bean id="MyA" class"com.company.MyA">
    <property name="name" value="gsh">
    <property name="ani" ref="ani">
</bean>
---------------------------------------------
2. 생성자
<bean id="MyA" class"com.company.MyA">
    <constructor-arg index="0" value="gsh">
    <constructor-arg index="1" ref="ani">
</bean>
---------------------------------------------
3. di-property
name=gsh
ani=cat
<context:property-placeholder location="classpath:config/test.properties"/>
<bean id="MyA" class"com.company.MyA">
    <constructor-arg index="0" value="${name}">
    <constructor-arg index="1" ref="${ani}">
</bean>
---------------------------------------------


1. xml vs Annotation
>> xml : 운영
>> Annotation : 개발

2. bean 의존관계 주입
2-1. @Autowired - 정밀한 의존관계
    - 프로퍼티, setter, 생성자 ,, 적용
2-2. @Qualifier - 동일한 타입의 bean 구분
2-3. @Value - 단순값
2-4. @Resource - 자원연결 (.properties)

3. @Component
- @Component 일반적인 컴포넌트 <bean> 스프링이 관리하는 객체
- @Component 구체화된 형식
    @Controller 웹 요청받아서 응닫
    @Service 서비스 레이어, 비즈니스 로직
    @Repository 데이터베이스

4. component-scan
<context:component-scan base-package="경로설정"/>
----------------------
#4. DB + MyBatis
----------------------
1. DataSource
+ SimpleDriverDataSource - 가장단순한 버전

2. MyBatis
 - sql을 별도로 파일 분리해서 관리
 - orm (object relational mapping) 프레임워크

3. 설정내용
root-context.xml - 환경정보설정
db.properties - db정보설정
SqlSessionFactoryBean - sqlsession 생성 및 관리
sqlsession - sql 실행, 트랜잭션
mapper.xml


-------------------------------
■ Q6. DTO
■ Q7. DAO
■ Q8. 
-------------------------------
■ Q9. 
■ Q10. 
■ Q11. 
-------------------------------
■ Q12. Controller
MVC
>> 서로 영향없이 고칠수 있는 애플리케이션을 만들수 있음.
- MODEL : DB (TABLE, DTO, DAO, SERVICE)
- VIEW : 화면 (HTML, CSS, JS/JQUERY)
- Controller : MODEL 과 VIEW 사이의 관리

>> MVC1 VS MVC2

>> FrontController
[클라이언트] → [FrontController *.do] → 세부Controller → view
                                    → 세부Controller → view
                                    → 세부Controller → view
1. FrontController - 공통작업먼저수행
2. 세부 Controller 작업 VIEW 최종결과 생성
                                
>> SPRING MVC
[클라이언트]
    ↓
[FrontController *.do]  <<DispatherServlet>>
    ↓ ↑                   Handler Mapping @Controller   → view (ViewResolver)
 세부Controller  
 세부Controller  
 세부Controller → db연동

 1) 클라이언트 요청
 2) DispatherServlet - Handler Mapping @Controller
 3) Controller 클라이언트의 요청처리
 4) DispatherServlet - ViewResolver 통해서 응답결과 처리

 [실습]
 1. [pom.xml] - spring-webmvc, jstl / jackson-mapper-asl
 2. [web.xml] - ContextLoaderListener / DispatherServlet (FrontController)
 3. [Service-context.xml] Controller위치설정, ViewResolver
 4. [Controller] list.do(처리,view) ,,,,, 설정
 5. [VIEW] 연동
 
 
■ Q13. VIEW 
 5. [VIEW] 연동
 ```
  <!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc -->
  <dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-webmvc</artifactId>
    <version>3.2.17.RELEASE</version>
  </dependency>
  
     <!-- https://mvnrepository.com/artifact/javax.servlet/jstl -->
   <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>jstl</artifactId>
      <version>1.2</version>
   </dependency>
   
   <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>jstl</artifactId>
      <version>1.2</version>
   </dependency>
   
   <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjrt -->
   <dependency>
       <groupId>org.aspectj</groupId>
       <artifactId>aspectjrt</artifactId>
       <version>1.7.3</version>
       <!-- <scope>runtime</scope> -->
   </dependency>
   <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
   <dependency>
       <groupId>org.aspectj</groupId>
       <artifactId>aspectjweaver</artifactId>
       <version>1.7.3</version>
      <!-- <scope>runtime</scope> -->
   </dependency>
   <!-- https://mvnrepository.com/artifact/org.springframework/spring-aop -->
   <dependency>
       <groupId>org.springframework</groupId>
       <artifactId>spring-aop</artifactId>
       <version>4.3.28.RELEASE</version>
   </dependency>
   

     <!-- https://mvnrepository.com/artifact/org.codehaus.jackson/jackson-mapper-asl -->
   <dependency>
       <groupId>org.codehaus.jackson</groupId>
       <artifactId>jackson-mapper-asl</artifactId>
       <version>1.9.13</version>
   </dependency>

   <!-- https://mvnrepository.com/artifact/javax.xml.bind/jaxb-api -->
   <dependency>
      <groupId>javax.xml.bind</groupId>
      <artifactId>jaxb-api</artifactId>
      <version>2.3.1</version>
   </dependency>
   <!-- https://mvnrepository.com/artifact/org.glassfish.jaxb/jaxb-core -->
   <dependency>
      <groupId>org.glassfish.jaxb</groupId>
      <artifactId>jaxb-core</artifactId>
      <version>2.3.0.1</version>
   </dependency>
   <!-- https://mvnrepository.com/artifact/com.sun.xml.bind/jaxb-impl -->
   <dependency>
      <groupId>com.sun.xml.bind</groupId>
      <artifactId>jaxb-impl</artifactId>
      <version>2.3.1</version>
   </dependency>   
 ```

■ Q14. 
---------------------
#6. Upload
---------------------
1. model
   > table : 이미지 경로필드

   SQL> desc sboard1;
   Name                                      Null?    Type
   ----------------------------------------- -------- ----------------------------
   ID                                        NOT NULL NUMBER
   APP_USER_ID                               NOT NULL NUMBER
   BTITLE                                    NOT NULL VARCHAR2(1000)
   BCONTENT                                  NOT NULL CLOB
   BPASS                                     NOT NULL VARCHAR2(255)
   BFILE                                              VARCHAR2(255)
   BHIT                                               NUMBER(10)
   BIP                                       NOT NULL VARCHAR2(255)
   CREATED_AT                                         TIMESTAMP(6)

   > dto :  bfile
   > dao :  insert, update

2. view
   form :  encType = "multipart/form-data"   method="post"
         <input type="file"  />

3. controller
   pom.xml
      <!-- img upload   start -->
      <!-- img upload   start -->
      <!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload -->
      <dependency>
          <groupId>commons-fileupload</groupId>
          <artifactId>commons-fileupload</artifactId>
          <version>1.3.1</version>
      </dependency>
      <!-- img upload end -->
      <!-- img upload end -->      

   servlet-context.xml
   FilUplad.java
   Controller.java - service


---------------------------------------------------------------------------

---------------------------------------------------------------------------

---------------------------------------------------------------------------


---------------------
#8. AOP + Mybatis
---------------------
1. AOP 개요
STEP1)
- 핵심기능 : (비지니스로직)
- 부가기능 : 핵심기능(비지니스로직)을 도와줌
>> AOP - 부가기능

  @Controller    /list.do
          ■ 부가기능                    ■ 부가기능
         [시작]-  Service  (전체리스트뽑아주는 service) -[끝]
             |  처리뷰   
             ↓
         [시작]- Repository(전체리스트뽑아주는 sql   )  -[끝]


STEP2) Aspect
- 기능분리
- 런타임 시 필요한 위치에 동적으로 처리
        Advice + PointCut = Aspect
  부가기능정의   적용부위

STEP3) 용어
Target   -  대상
Advice   -  부가기능
PointCut -  적용할 타겟의 메서드를 선별하는 정규식
Weaving  -  Target에 부가기능 처리(삽입)하는 과정


STEP4) 
<<BEFORE>>         
application         
[
 [  비지니스로직    ]
 [  보안, 인증, 로직]
]

<<AFTER>>
application         
[
 **********************           
 *[   PointCut 적용부위 ]    Weaving  →    [  비지니스로직    ]
        ↑
 *[   Advice 부가기능   ] *
       ↑
 *[  보안, 인증, 로직   ] *
 *   [Aspect]
 **********************  
]
Target   -  대상
Advice   -  부가기능
PointCut -  적용할 타겟의 메서드를 선별하는 정규식
Weaving  -  Target에 부가기능 처리(삽입)하는 과정


2. AOP 특징
>> 프록시 기반 aop를 지원
- 프록시는 advice(부가기능)을 target(대상객체)에 적용하면서 생성되는 객체
- Target(대상객체)를 감싸는 프록시는 런타임 시에 생성됨.
- 타겟객체에 대한 호출을 intercept(가로채서)해서  
  A. 부가기능 수행 후 타겟의 핵심기능 로직호출(전처리)  , 
  B. 타겟의 핵심기능 로직호출  부가기능 수행  (후처리) 
  

   호출 --->   [ Proxy  [Target]  ]

3. 구현방식
1) xml
2) annotation

실습1) pom.xml
1. AspectJ runtime   -> AspectJrt
2. AspectJ weaver    -> AspectJweaver
3. Spring aop        -> spring-aop
4. api 문서
https://www.eclipse.org/aspectj/doc/next/runtime-api/

<!-- https://mvnrepository.com/artifact/org.aspectj/aspectjrt -->
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjrt</artifactId>
    <version>1.7.3</version>
    <!-- <scope>runtime</scope>  -->
</dependency>
<!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.7.3</version>
    <!-- <scope>runtime</scope> -->
</dependency>
<!-- https://mvnrepository.com/artifact/org.springframework/spring-aop -->
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-aop</artifactId>
    <version>4.3.28.RELEASE</version>
</dependency>



실습2)  Advice + PointCut = Aspect
  부가기능정의   적용부위

com.thejoa703.aop
>> AopTrace.java


import org.aspectj.lang.ProceedingJoinPoint;

public class AopTrace {
   public Object trace( ProceedingJoinPoint  joinPoint)  throws Throwable{
      // 타겟메서드의 정보
      String signature = joinPoint.getSignature().toShortString();
      System.out.println(">>>> " + signature + " START! ");
      // 타겟메서드 호출시간확인
      long start = System.currentTimeMillis();
      // 타겟메서드 호출
      Object  result = joinPoint.proceed();
      long end  = System.currentTimeMillis();
      System.out.println("..... 실행시간 : " + (end - start)  + "ms");
      System.out.println(">>>> " + signature + " END! ");
      return result;
   }
}


실습3)  servlet-context.xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:aop="http://www.springframework.org/schema/aop"
   xsi:schemaLocation="http://www.springframework.org/schema/beans    http://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd">
   
   <aop:config>
      <aop:aspect  id="traceAspect"   ref="aopTrace" >
         <aop:around     method="trace"  
                    pointcut="execution(public * com.company.service..*(..))"
          />
      </aop:aspect>
   </aop:config>
   
   <!-- Advice 클래스 Bean 등록 -->
   <bean  id="aopTrace"   class="com.company.aop_xml.AopTrace" />
</beans>



Aop 설정    
   1. aop:config  aop 설정정보  -  bean
   2. aspect :  advice + point cut
   3. aop:around
   aop:around
   aop:before  실행 전
   aop:after   실행 후
   aop:after-returning   정상 실행시  
   aop:after-throwing    예외 발생시  
   
   1) exection(* hello(..) )  
      hello라는 이름 메서드 / 파라미터종류는 모두
   2) exection(* hello()   )  
      hello라는 이름 메서드 / 파라미터종류는 안됨.
   3) exection(* com.company.service.UserSeviceImpl.*(..)   )  
      UserSeviceImpl 클래스의 모든메서드
   4) exection(* com.company.service.*.*(..)   )      
      service안의 모든클래스
   5) exection(* com.company.service..*(..)   )  
      .. 서브패키지의 모든클래스  

   >> https://docs.spring.io/spring-framework/docs/2.0.x/reference/aop.html

■ MYBATIS
> 동적sql
WHY)
select * from emp;
select * from emp  where ename='Scott';
select * from emp  where job='SALESMAN';

SQL 구문)  MYBATIS 3개


Q1) select * from emp  where  ${searchType} = #{keyword}
1-1. select * from emp  where ename='Scott';
1-2. select * from emp  where job='SALESMAN';

${searchType} → ''안붙음  stmt
#{keyword}    → ''자동    pstmt

Q2) select * from emp where ename=#{ename} <if test="job!=null"> and job=#{job} </if>

select * from emp where ename='SMITH'
select * from emp  where ename='SMITH' and job='CLERK'

select * from emp where empno=7369 and ename=''SMITH and job='CLERK' and mgr=7902 


Q7) JOIN

   >desc authorities

   userid varchar2(100)
   auth   varchar2(100)

Q1. create table
Q2. 필드명 바꾸기 : alter table authorities rename column userid to email;
Q3. 있는 email로 insert 하기 : 
   SQL> insert into authorities (email, auth) values ('q3@q3','MEMBER');
   SQL> insert into authorities (email, auth) values ('q3@q3','ADMIN');
Q4. join 이용해서 email, password, auth 출력하기 (4가지)

### 3️⃣ JOIN 종류별 예시

#### ① INNER JOIN (같은 이메일만)

```sql
SELECT u.email, u.password, a.auth
FROM appuser u
JOIN authorities a
  ON u.email = a.email
where u.email = 'q3@q3';
```

#### ② LEFT JOIN (appuser 기준, 권한 없을 수도 있음)

```sql
SELECT u.email, u.password, a.auth
FROM appuser u
LEFT JOIN authorities a
  ON u.email = a.email
  where u.email = 'q3@q3';
```

#### ③ RIGHT JOIN (authorities 기준, 유저 없을 수도 있음)

```sql
SELECT u.email, u.password, a.auth
FROM appuser u
RIGHT JOIN authorities a
  ON u.email = a.email
  where u.email = 'q3@q3';
```

#### ④ FULL OUTER JOIN (모든 유저 + 모든 권한 포함)

```sql
SELECT u.email, u.password, a.auth
FROM appuser u
FULL OUTER JOIN authorities a
  ON u.email = a.email
  where u.email = 'q3@q3';
```


>desc appuser
SQL> desc appuser;
 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------------
 APP_USER_ID                               NOT NULL NUMBER(5)
 EMAIL                                     NOT NULL VARCHAR2(100)
 PASSWORD                                           VARCHAR2(255)
 MBTI_TYPE_ID                                       NUMBER(5)
 CREATED_AT                                         DATE
 UFILE                                              VARCHAR2(255)


---------------------
#9. PAGING
---------------------
1. 프로젝트 복사하기  ( spring005 복사해서 spring007_paging )
2. 페이징?
model
   > table
      delete from sboard1;

      insert into sboard1 ( ID    , APP_USER_ID , btitle, bcontent, bpass, bfile,  bip )
      values  (  sboard1_seq.nextval , 1 , 'title', 'content', '1111', '',  '127.0.0.1' );

      insert into sboard1 ( ID    , APP_USER_ID , btitle, bcontent, bpass, bfile,  bip )
      select  sboard1_seq.nextval , APP_USER_ID , btitle, bcontent, bpass, bfile,  bip   from sboard1;
 
   > dto
      PagingDto

   > dao   10개씩
      select  *
       from  (
         select     row_number()   over (  order by  created_at desc )  as  rnum , 
         id  , app_user_id , btitle, bcontent, bpass, bfile,  bip , bhit, created_at
         from sboard1
      )  A
      where   A.rnum  between  1   and 10 

      1페이지   시작 1  , 끝 10
      2페이지   시작 11 , 끝 20
      3페이지   시작 21 , 끝 30

      select  count(*) from sboard1


SQL> desc sboard1;
 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------------
 ID                                        NOT NULL NUMBER
 APP_USER_ID                               NOT NULL NUMBER
 BTITLE                                    NOT NULL VARCHAR2(1000)
 BCONTENT                                  NOT NULL CLOB
 BPASS                                     NOT NULL VARCHAR2(255)
 BFILE                                              VARCHAR2(255)
 BHIT                                               NUMBER(10)
 BIP                                       NOT NULL VARCHAR2(255)
 CREATED_AT                                         TIMESTAMP(6)



view
controller

---------------------
#10. SECURITY?
---------------------
▶ 1. Security?
   - 애플리케이션의 보안(인증,인가)를 담당
   - filter 흐름에 따라 처리

▶ 2. 인증 vs 인가
   - 인증 authentication [본인]이 맞는지 확인
   - 인가 authorization  인증된 사용자가 [접근가능]

▶ 3. Security 아키텍쳐
=====================
       ② [★UsernamePasswordAuthentication Token★]
          ↓
① Http Request  →     [AuthenticationFilter] ③ ...  →  [Authentication  Manager]
         ↓⑩               ⑨     ←
          [SecurityContextHolder]
=====================

- 1. 사용자가 로그인 폼태그 시도 (username + password 전달)
- 2. ★UsernamePasswordAuthentication★ 요청정보 authentication을 생성
- 3. authorization 인증처리

- 10. 인증완료 [사용자 정보] SecurityContextHolder 담기
   - authenticationSuccessHandler 를 실행(성공)
   - authenticationFailureHandler 를 실행(실패)

=====================
[Authentication  Manager] -> [Aauthentication Provider(s)]
=====================
- 4. Aauthentication Provider(s) 인증담당.
1) ★UsernamePasswordAuthentication Token★ 은 Provider를 찾는데 사용
2) Aauthentication Provider      ★ 로그인정보 db정보와 비교
3) UserDetilsService             ★ db에 있는 [사용자정보] 가져오기

[실습처리]
1. pom.xml - Security
2. security-context.xml
3. web.xml 스프링 구동
4. SecurityController
5. 테스트

## 1. pom.xml
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-core -->
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-web</artifactId>
         <version>4.2.2.RELEASE</version>
         <!-- <version>5.0.7.RELEASE</version> -->
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-config</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-core</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-taglibs</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- SECURITY -->


##2. security-context.xml 
##3. web.xml 스프링 구동
##4. SecurityController
##5. 테스트

[실습1] DB연동
1. security-context.xml 
2. user-mapper.xml      / UserDao / mybatis-config.xml (Dto) 확인
   1) 권한 삽입
   SQL> insert into authorities (email, auth) values ('q3@q3','ROLE_MEMBER');
   SQL> insert into authorities (email, auth) values ('q3@q3','ROLE_ADMIN');

   2) email, password, 권한
   SELECT u.email, u.password, a.auth
   FROM appuser u
   JOIN authorities a
   ON u.email = a.email
   where u.email = 'q3@q3';

3. TEST

[실습3] 로그인
1. security-context.xml
   로그인 폼
   로그인 성공
   로그인 실패
   유저정보

2. 설정내용 com.thejoa703.security 
3. Controller - 로그인
4. view - login.jsp